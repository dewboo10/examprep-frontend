<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Manage Mocks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #1f2937;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: #1f2937;
      min-height: 100vh;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.2);
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .sidebar-header h2 {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .sidebar-header p {
      font-size: 0.9rem;
      color: #6b7280;
      font-weight: 500;
    }

    .nav-section {
      margin-bottom: 2rem;
    }

    .nav-section-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      padding-left: 0.5rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      border-radius: 12px;
      color: #374151;
      font-weight: 500;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      text-decoration: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      z-index: 0;
    }

    .nav-link:hover::before,
    .nav-link.active::before {
      width: 100%;
    }

    .nav-link:hover,
    .nav-link.active {
      color: white;
      transform: translateX(4px);
    }

    .nav-link i {
      z-index: 1;
      position: relative;
      font-size: 1.1rem;
    }

    .nav-link span {
      z-index: 1;
      position: relative;
    }

    .nav-link.active {
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 2rem;
      border-top: 1px solid #e5e7eb;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .admin-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1rem;
    }

    .admin-details h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .admin-details p {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .logout-btn {
      width: 100%;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }

    /* Main Content */
    .main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 2.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .filters {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
    }

    .filters label {
      font-weight: 500;
      color: #374151;
    }

    .filters input, .filters select {
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      margin-left: 0.4rem;
      transition: border-color 0.3s ease;
    }

    .filters input:focus, .filters select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .filters button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filters button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .filters button.create-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .filters button.create-btn:hover {
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    .filters button.upload-btn {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    }

    .filters button.upload-btn:hover {
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    }

    .filters button.download-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .filters button.download-btn:hover {
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }

    th, td {
      border-bottom: 1px solid #f3f4f6;
      padding: 1rem 0.75rem;
      text-align: left;
      font-size: 1rem;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
      letter-spacing: 0.5px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: #f9fafb;
    }

    td.actions {
      min-width: 180px;
    }

    .action-btn {
      background: none;
      border: none;
      color: #667eea;
      font-size: 1.1rem;
      margin: 0 0.3rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 0.5rem;
    }

    .action-btn:hover {
      background: #f3f4f6;
      color: #4f46e5;
      transform: translateY(-1px);
    }

    .action-btn.delete:hover {
      background: #fef2f2;
      color: #dc2626;
    }

    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      padding: 2.5rem;
      min-width: 400px;
      max-width: 95vw;
      position: relative;
      animation: popIn 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .modal label {
      display: block;
      margin-bottom: 0.5rem;
      color: #374151;
      font-weight: 500;
      position: relative;
    }

    .modal input, .modal select, .modal textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      background: #f9fafb;
      margin-bottom: 1rem;
      transition: border-color 0.3s ease;
    }

    .modal input:focus, .modal select:focus, .modal textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .modal .modal-actions button {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal .modal-actions .save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .modal .modal-actions .save:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .modal .modal-actions .cancel {
      background: #f3f4f6;
      color: #374151;
    }

    .modal .modal-actions .cancel:hover {
      background: #e5e7eb;
    }

    .modal .modal-actions .danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .modal .modal-actions .danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .sidebar {
        width: 240px;
        padding: 1.5rem 1rem;
      }
      
      .main {
        padding: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        min-height: auto;
        padding: 1rem;
      }
      
      .sidebar-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
      }
      
      .nav-section {
        margin-bottom: 1rem;
      }
      
      .main {
        padding: 1rem;
      }
      
      .container {
        padding: 1.5rem;
      }
      
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filters > * {
        margin-bottom: 0.5rem;
      }
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container {
      animation: fadeInUp 0.6s ease forwards;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>
        <i class="fas fa-cogs"></i>
        Admin Panel
      </h2>
      <p>Exam Prep Platform</p>
    </div>

    <nav class="nav-section">
      <div class="nav-section-title">Main Navigation</div>
      <a href="dashboard.html" class="nav-link">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </a>
      <a href="admin-questions.html" class="nav-link">
        <i class="fas fa-question"></i>
        <span>Questions</span>
      </a>
      <a href="mock.html" class="nav-link active">
        <i class="fas fa-list-ol"></i>
        <span>Mock Tests</span>
      </a>
      <a href="user.html" class="nav-link">
        <i class="fas fa-users"></i>
        <span>Users</span>
      </a>
    </nav>

    <nav class="nav-section">
      <div class="nav-section-title">Management</div>
      <a href="#" class="nav-link">
        <i class="fas fa-bell"></i>
        <span>Notifications</span>
      </a>
      <a href="#" class="nav-link">
        <i class="fas fa-chart-bar"></i>
        <span>Analytics</span>
      </a>
      <a href="#" class="nav-link">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="admin-info">
        <div class="admin-avatar">A</div>
        <div class="admin-details">
          <h4>Admin User</h4>
          <p>Super Administrator</p>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <h1><i class="fas fa-list-ol"></i> Manage Mock Tests</h1>
      <div id="adminMsg" style="margin-bottom:1rem;min-height:28px;font-weight:600;"></div>
      <div class="filters">
        <label>Exam: 
          <select id="filterExam">
            <option value="">All Exams</option>
          </select>
        </label>
        <label>Day: <input id="filterDay" type="number" min="1" placeholder="Day"></label>
        <label>Status: 
          <select id="filterStatus">
            <option value="">All</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="draft">Draft</option>
          </select>
        </label>
        <input id="filterSearch" placeholder="Search mocks..." style="flex:1;min-width:180px;">
        <button id="filterSearchBtn"><i class="fas fa-search"></i> Search</button>
        <button onclick="showCreateMockModal()" class="create-btn"><i class="fas fa-plus"></i> Create New Mock</button>
        <label style="display:flex;align-items:center;gap:0.5rem;">
          <input type="file" id="csvMockFileInput" accept=".csv" style="display:none;" onchange="handleMockCSVSelected(event)">
          <button type="button" onclick="document.getElementById('csvMockFileInput').click()" class="upload-btn"><i class="fas fa-upload"></i> Bulk Upload (CSV)</button>
        </label>
        <button type="button" onclick="downloadMocksCSV()" class="download-btn"><i class="fas fa-download"></i> Download All as CSV</button>
      </div>
      <table id="mocksTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Exam</th>
            <th>Day</th>
            <th>Status</th>
            <th>#Questions</th>
            <th>Created</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Create/Edit Mock Modal -->
  <div id="mockModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
      <h3 id="mockModalTitle"><i class="fas fa-plus"></i> Create/Edit Mock</h3>
      <form id="mockForm">
        <label>Name: <input id="mockName" required></label>
        <label>Exam: 
          <select id="mockExam" required>
            <option value="">Select Exam</option>
          </select>
        </label>
        <label>Day: <input id="mockDay" type="number" min="1" required></label>
        <label>Description: <textarea id="mockDescription" rows="3"></textarea></label>
        <label>Status: 
          <select id="mockStatus" required>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="draft">Draft</option>
          </select>
        </label>
        <label>Time Limit (minutes): <input id="mockTimeLimit" type="number" min="0"></label>
        <label>Max Attempts: <input id="mockMaxAttempts" type="number" min="1"></label>
        <label>Start Date: <input id="mockStartDate" type="datetime-local"></label>
        <label>End Date: <input id="mockEndDate" type="datetime-local"></label>
        <div class="modal-actions">
          <button type="submit" class="save" id="mockSubmitBtn"><span id="mockSpinner" style="display:none;"><i class='fas fa-spinner fa-spin'></i></span> <i class="fas fa-save"></i> Save</button>
          <button type="button" class="cancel" onclick="closeMockModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Assign Questions Modal -->
  <div id="assignQuestionsModalBg" class="modal-bg" style="display:none;">
    <div class="modal" style="max-width:700px;">
      <h3><i class="fas fa-tasks"></i> Assign Questions to Mock</h3>
      <div id="assignQuestionsContent">
        <!-- Placeholder for question assignment UI -->
        <p>Loading questions...</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="save" onclick="saveAssignedQuestions()"><i class="fas fa-save"></i> Save</button>
        <button type="button" class="cancel" onclick="closeAssignQuestionsModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div id="analyticsModalBg" class="modal-bg" style="display:none;">
    <div class="modal" style="max-width:700px;">
      <h3><i class="fas fa-chart-bar"></i> Mock Analytics</h3>
      <div id="analyticsContent">
        <!-- Placeholder for analytics UI -->
        <p>Loading analytics...</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="cancel" onclick="closeAnalyticsModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Set your backend API base URL here
    const API_BASE = 'https://examprep-backend.onrender.com/api/admin';
    function isTokenExpired(token) {
      if (!token) return true;
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (!payload.exp) return false;
        const now = Math.floor(Date.now() / 1000);
        return payload.exp < now;
      } catch (e) { return true; }
    }
    function getAdminToken() {
      let token = localStorage.getItem('adminToken') || '';
      if (!token || isTokenExpired(token)) {
        token = prompt('Enter your admin JWT token:');
        localStorage.setItem('adminToken', token);
      }
      return token;
    }
    let editingMockId = null;
    // Fetch exams and populate the filter dropdown with ObjectIds
    async function loadExams() {
      try {
        const res = await fetch('https://examprep-backend.onrender.com/api/exams');
        const exams = await res.json();
        const filterExam = document.getElementById('filterExam');
        filterExam.innerHTML = '<option value="">All Exams</option>';
        exams.forEach(exam => {
          filterExam.innerHTML += `<option value="${exam._id}">${exam.code} - ${exam.name}</option>`;
        });
      } catch (e) {
        // fallback: show only default option
      }
    }
    // Ensure the search button triggers fetchMocks and uses ObjectId
    document.addEventListener('DOMContentLoaded', function() {
      loadExams();
      const searchBtn = document.getElementById('filterSearchBtn');
      if (searchBtn) {
        searchBtn.onclick = function() {
          // Debug: log the selected exam value
          const examId = document.getElementById('filterExam').value;
          console.log('Exam filter value (should be ObjectId):', examId);
          fetchMocks();
        };
      }
    });
    // Update fetchMocks to use ObjectId for exam filter
    async function fetchMocks() {
      let token = getAdminToken();
      if (!token || isTokenExpired(token)) {
        token = prompt('Enter your admin JWT token:');
        if (!token) {
          showAdminMsg('No token provided. Please enter a valid admin token.', true);
          return;
        }
        localStorage.setItem('adminToken', token);
      }
      
      const examId = document.getElementById('filterExam').value;
      const day = document.getElementById('filterDay').value;
      const status = document.getElementById('filterStatus').value;
      const search = document.getElementById('filterSearch').value;
      
      let url = `${API_BASE}/mocks?`;
      if (examId) url += `exam=${encodeURIComponent(examId)}&`;
      if (day) url += `day=${encodeURIComponent(day)}&`;
      if (status) url += `status=${encodeURIComponent(status)}&`;
      if (search) url += `search=${encodeURIComponent(search)}&`;
      
      try {
        showAdminMsg('Fetching mocks...', false);
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        
        if (res.status === 401) {
          showAdminMsg('Session expired or unauthorized. Please log in again.', true);
          localStorage.removeItem('adminToken');
          return;
        }
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          showAdminMsg(`Failed to fetch mocks: ${errorData.message || res.statusText}`, true);
          return;
        }
        
        const mocks = await res.json();
        const tbody = document.querySelector('#mocksTable tbody');
        tbody.innerHTML = '';
        
        if (!mocks || !mocks.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center; padding: 2rem; color: #6b7280;">
                <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                No mocks found for the selected criteria.
              </td>
            </tr>
          `;
          showAdminMsg('No mocks found for the selected criteria.');
          return;
        }
        
        mocks.forEach(mock => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${mock.id || mock._id}</td>
            <td>${mock.name}</td>
            <td>${mock.exam}</td>
            <td>${mock.day}</td>
            <td>${mock.status}</td>
            <td>${mock.numQuestions || (mock.questions ? mock.questions.length : 0)}</td>
            <td>${mock.createdAt ? new Date(mock.createdAt).toLocaleString() : ''}</td>
            <td>${mock.updatedAt ? new Date(mock.updatedAt).toLocaleString() : ''}</td>
            <td class="actions">
              <button class="action-btn" title="Edit" onclick='showCreateMockModal(${JSON.stringify(mock)})'><i class="fas fa-edit"></i></button>
              <button class="action-btn delete" title="Delete" onclick="deleteMock('${mock._id}')"><i class="fas fa-trash"></i></button>
              <button class="action-btn" title="Assign Questions" onclick="showAssignQuestionsModal('${mock._id}')"><i class="fas fa-tasks"></i></button>
              <button class="action-btn" title="Analytics" onclick="showAnalyticsModal('${mock._id}')"><i class="fas fa-chart-bar"></i></button>
              <button class="action-btn" title="Clone" onclick="cloneMock('${mock._id}')"><i class="fas fa-copy"></i></button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        showAdminMsg(`Successfully fetched ${mocks.length} mocks.`);
      } catch (e) {
        console.error('Fetch error:', e);
        document.querySelector('#mocksTable tbody').innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem; color: #ef4444;">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
              Error loading mocks. Please check your connection and try again.
            </td>
          </tr>
        `;
        showAdminMsg('Failed to fetch mocks. Please check your connection and try again.', true);
      }
    }
    // Add this function to populate the exam select in the modal
    async function populateMockExamSelect(selectedExamId) {
      try {
        const res = await fetch('https://examprep-backend.onrender.com/api/exams');
        const exams = await res.json();
        const mockExamSelect = document.getElementById('mockExam');
        mockExamSelect.innerHTML = '<option value="">Select Exam</option>';
        exams.forEach(exam => {
          mockExamSelect.innerHTML += `<option value="${exam._id}"${selectedExamId === exam._id ? ' selected' : ''}>${exam.code} - ${exam.name}</option>`;
        });
      } catch (e) {
        // fallback: show only default option
      }
    }
    function showCreateMockModal(mock) {
      document.getElementById('mockModalBg').style.display = 'flex';
      document.getElementById('mockModalTitle').innerHTML = mock ? '<i class="fas fa-edit"></i> Edit Mock' : '<i class="fas fa-plus"></i> Create Mock';
      editingMockId = mock ? (mock.id || mock._id) : null;
      document.getElementById('mockName').value = mock?.name || '';
      populateMockExamSelect(mock?.exam || '');
      document.getElementById('mockDay').value = mock?.day || '';
      document.getElementById('mockDescription').value = mock?.description || '';
      document.getElementById('mockStatus').value = mock?.status || 'active';
      document.getElementById('mockTimeLimit').value = mock?.timeLimit || '';
      document.getElementById('mockMaxAttempts').value = mock?.maxAttempts || '';
      document.getElementById('mockStartDate').value = mock?.startDate ? new Date(mock.startDate).toISOString().slice(0,16) : '';
      document.getElementById('mockEndDate').value = mock?.endDate ? new Date(mock.endDate).toISOString().slice(0,16) : '';
    }
    function closeMockModal() { document.getElementById('mockModalBg').style.display = 'none'; editingMockId = null; }
    document.getElementById('mockForm').onsubmit = async function(e) {
      e.preventDefault();
      
      let token = getAdminToken();
      if (!token || isTokenExpired(token)) {
        token = prompt('Enter your admin JWT token:');
        if (!token) {
          showAdminMsg('No token provided. Please enter a valid admin token.', true);
          return;
        }
        localStorage.setItem('adminToken', token);
      }
      
      const data = {
        name: document.getElementById('mockName').value.trim(),
        exam: document.getElementById('mockExam').value,
        day: document.getElementById('mockDay').value,
        description: document.getElementById('mockDescription').value.trim(),
        status: document.getElementById('mockStatus').value,
        timeLimit: document.getElementById('mockTimeLimit').value,
        maxAttempts: document.getElementById('mockMaxAttempts').value,
        startDate: document.getElementById('mockStartDate').value,
        endDate: document.getElementById('mockEndDate').value
      };
      
      // Validation
      if (!data.name || !data.exam || !data.day) {
        showAdminMsg('Please fill all required fields (Name, Exam, Day).', true);
        return;
      }
      
      try {
        showAdminMsg(editingMockId ? 'Updating mock...' : 'Creating mock...', false);
        let res;
        if (editingMockId) {
          res = await fetch(`${API_BASE}/mocks/${editingMockId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch(`${API_BASE}/mocks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(data)
          });
        }
        
        if (res.status === 401) {
          showAdminMsg('Session expired or unauthorized. Please log in again.', true);
          localStorage.removeItem('adminToken');
          return;
        }
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          showAdminMsg(`Failed to save mock: ${errorData.message || res.statusText}`, true);
          return;
        }
        
        showAdminMsg(editingMockId ? 'Mock updated successfully!' : 'Mock created successfully!');
        closeMockModal();
        fetchMocks();
      } catch (e) {
        console.error('Save error:', e);
        showAdminMsg('Failed to save mock. Please check your connection and try again.', true);
      }
    };
    async function deleteMock(id) {
      if (!confirm('Are you sure you want to delete this mock?')) return;
      
      let token = getAdminToken();
      if (!token || isTokenExpired(token)) {
        token = prompt('Enter your admin JWT token:');
        if (!token) {
          showAdminMsg('No token provided. Please enter a valid admin token.', true);
          return;
        }
        localStorage.setItem('adminToken', token);
      }
      
      try {
        showAdminMsg('Deleting mock...', false);
        const res = await fetch(`${API_BASE}/mocks/${id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        
        if (res.status === 401) {
          showAdminMsg('Session expired or unauthorized. Please log in again.', true);
          localStorage.removeItem('adminToken');
          return;
        }
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          showAdminMsg(`Failed to delete mock: ${errorData.message || res.statusText}`, true);
          return;
        }
        
        showAdminMsg('Mock deleted successfully!');
        fetchMocks();
      } catch (e) {
        console.error('Delete error:', e);
        showAdminMsg('Failed to delete mock. Please check your connection and try again.', true);
      }
    }
    // Assign Questions
    function showAssignQuestionsModal(mockId) {
      document.getElementById('assignQuestionsModalBg').style.display = 'flex';
      loadAssignQuestions(mockId);
    }
    function closeAssignQuestionsModal() { document.getElementById('assignQuestionsModalBg').style.display = 'none'; }
    async function loadAssignQuestions(mockId) {
      const token = getAdminToken();
      const container = document.getElementById('assignQuestionsContent');
      container.innerHTML = '<p>Loading questions...</p>';
      try {
        const res = await fetch(`${API_BASE}/mocks/${mockId}/questions`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to load questions');
        const data = await res.json();
        // Render checkboxes for all questions (simplified for now)
        container.innerHTML = '<div style="max-height:300px;overflow:auto;">' +
          data.allQuestions.map(q => `
            <label style="display:block;margin-bottom:4px;">
              <input type="checkbox" value="${q._id}" ${data.assignedQuestions.includes(q._id) ? 'checked' : ''}> ${q.question}
            </label>
          `).join('') + '</div>';
        container.innerHTML += '<p style="margin-top:1em;color:#888;font-size:0.95em;">Check to assign, uncheck to remove. Save to apply changes.</p>';
        container.dataset.mockId = mockId;
      } catch (e) {
        container.innerHTML = '<p style="color:#e11d48;">Error loading questions.</p>';
      }
    }
    async function saveAssignedQuestions() {
      const token = getAdminToken();
      const container = document.getElementById('assignQuestionsContent');
      const mockId = container.dataset.mockId;
      const checked = Array.from(container.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
      try {
        const res = await fetch(`${API_BASE}/mocks/${mockId}/questions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ questionIds: checked })
        });
        if (!res.ok) throw new Error('Failed to assign questions');
        closeAssignQuestionsModal();
        fetchMocks();
      } catch (e) {
        alert('Error assigning questions: ' + e.message);
      }
    }
    // Analytics
    function showAnalyticsModal(mockId) {
      document.getElementById('analyticsModalBg').style.display = 'flex';
      loadAnalytics(mockId);
    }
    function closeAnalyticsModal() { document.getElementById('analyticsModalBg').style.display = 'none'; }
    async function loadAnalytics(mockId) {
      const token = getAdminToken();
      const container = document.getElementById('analyticsContent');
      container.innerHTML = '<p>Loading analytics...</p>';
      try {
        const res = await fetch(`${API_BASE}/mocks/${mockId}/analytics`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to load analytics');
        const data = await res.json();
        // Render analytics (simplified)
        container.innerHTML = `
          <div><b>Attempts:</b> ${data.attempts}</div>
          <div><b>Average Score:</b> ${data.avgScore}</div>
          <div><b>Completion Rate:</b> ${data.completionRate}%</div>
          <div><b>Top Performers:</b><ul>${(data.topPerformers||[]).map(u => `<li>${u.name} (${u.score})</li>`).join('')}</ul></div>
        `;
      } catch (e) {
        container.innerHTML = '<p style="color:#e11d48;">Error loading analytics.</p>';
      }
    }
    // Clone Mock
    async function cloneMock(id) {
      if (!confirm('Clone this mock?')) return;
      const token = getAdminToken();
      try {
        const res = await fetch(`${API_BASE}/mocks/${id}/clone`, {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to clone mock');
        fetchMocks();
      } catch (e) {
        alert('Error cloning mock: ' + e.message);
      }
    }
    // Bulk Upload
    async function handleMockCSVSelected(event) {
      const token = getAdminToken();
      const file = event.target.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch(`${API_BASE}/mocks/upload-csv`, {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token },
          body: formData
        });
        if (!res.ok) throw new Error('Failed to upload CSV');
        alert('CSV uploaded successfully!');
        fetchMocks();
      } catch (e) {
        alert('CSV upload failed: ' + e.message);
      }
      document.getElementById('csvMockFileInput').value = '';
    }
    // Bulk Download
    async function downloadMocksCSV() {
      const token = getAdminToken();
      try {
        const res = await fetch(`${API_BASE}/mocks/download-csv`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to download CSV');
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mocks.csv';
        a.click();
      } catch (e) {
        alert('CSV download failed: ' + e.message);
      }
    }
    // Initial fetch
    fetchMocks();

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('adminToken');
        window.location.href = '../login.html';
      }
    }

    // Show admin message function
    function showAdminMsg(msg, isError = false) {
      const el = document.getElementById('adminMsg');
      el.textContent = msg;
      el.style.color = isError ? '#ef4444' : '#059669';
      el.style.background = isError ? '#fef2f2' : '#f0fdf4';
      el.style.borderRadius = '8px';
      el.style.padding = '0.75rem 1rem';
      el.style.transition = 'all 0.3s ease';
      if (msg) setTimeout(() => { el.textContent = ''; el.style.background = 'none'; }, 4000);
    }
  </script>
</body>
</html> 