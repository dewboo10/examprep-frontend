<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #1f2937;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: #1f2937;
      min-height: 100vh;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.2);
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .sidebar-header h2 {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .sidebar-header p {
      font-size: 0.9rem;
      color: #6b7280;
      font-weight: 500;
    }

    .nav-section {
      margin-bottom: 2rem;
    }

    .nav-section-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      padding-left: 0.5rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      border-radius: 12px;
      color: #374151;
      font-weight: 500;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      text-decoration: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      z-index: 0;
    }

    .nav-link:hover::before,
    .nav-link.active::before {
      width: 100%;
    }

    .nav-link:hover,
    .nav-link.active {
      color: white;
      transform: translateX(4px);
    }

    .nav-link i {
      z-index: 1;
      position: relative;
      font-size: 1.1rem;
    }

    .nav-link span {
      z-index: 1;
      position: relative;
    }

    .nav-link.active {
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 2rem;
      border-top: 1px solid #e5e7eb;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .admin-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1rem;
    }

    .admin-details h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .admin-details p {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .logout-btn {
      width: 100%;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }

    /* Main Content */
    .main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .dashboard-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 2.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .dashboard-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .dashboard-header p {
      color: #6b7280;
      font-size: 1.1rem;
      font-weight: 400;
      max-width: 600px;
    }

    .welcome-message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-top: 1rem;
      font-weight: 500;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .stat-card.questions::before {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card.mocks::before {
      background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.users::before {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.active::before {
      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card.questions .stat-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card.mocks .stat-icon {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.users .stat-icon {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.active .stat-icon {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 1rem;
      color: #6b7280;
      font-weight: 500;
    }

    .stat-change {
      font-size: 0.9rem;
      color: #059669;
      font-weight: 600;
    }

    /* Quick Actions */
    .quick-actions {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .quick-actions h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .action-card {
      background: #f8fafc;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.5rem;
      text-decoration: none;
      color: #374151;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .action-card:hover {
      border-color: #667eea;
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .action-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .action-card.questions .action-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .action-card.mocks .action-icon {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .action-card.users .action-icon {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .action-content h4 {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .action-content p {
      font-size: 0.875rem;
      color: #6b7280;
    }

    /* Recent Activity */
    .recent-activity {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .recent-activity h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .activity-list {
      list-style: none;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .activity-content h4 {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #1f2937;
    }

    .activity-content p {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

         .activity-time {
       font-size: 0.8rem;
       color: #9ca3af;
       margin-left: auto;
     }

     /* Empty State */
     .empty-state {
       text-align: center;
       padding: 3rem 2rem;
       color: #6b7280;
     }

     .empty-state i {
       font-size: 3rem;
       margin-bottom: 1rem;
       color: #d1d5db;
     }

     .empty-state h3 {
       font-size: 1.25rem;
       font-weight: 600;
       margin-bottom: 0.5rem;
       color: #374151;
     }

     .empty-state p {
       font-size: 1rem;
       color: #6b7280;
     }

     /* Loading States */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #667eea;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .sidebar {
        width: 240px;
        padding: 1.5rem 1rem;
      }
      
      .main {
        padding: 1.5rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        min-height: auto;
        padding: 1rem;
      }
      
      .sidebar-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
      }
      
      .nav-section {
        margin-bottom: 1rem;
      }
      
      .main {
        padding: 1rem;
      }
      
      .dashboard-header {
        padding: 1.5rem;
      }
      
      .dashboard-header h1 {
        font-size: 2rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .actions-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stat-card,
    .quick-actions,
    .recent-activity {
      animation: fadeInUp 0.6s ease forwards;
    }

    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:nth-child(4) { animation-delay: 0.4s; }
    .quick-actions { animation-delay: 0.5s; }
    .recent-activity { animation-delay: 0.6s; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>
        <i class="fas fa-cogs"></i>
        Admin Panel
      </h2>
      <p>Exam Prep Platform</p>
    </div>

    <nav class="nav-section">
      <div class="nav-section-title">Main Navigation</div>
      <a href="dashboard.html" class="nav-link active">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </a>
      <a href="admin-questions.html" class="nav-link">
        <i class="fas fa-question"></i>
        <span>Questions</span>
      </a>
      <a href="mock.html" class="nav-link">
        <i class="fas fa-list-ol"></i>
        <span>Mock Tests</span>
      </a>
      <a href="user.html" class="nav-link">
        <i class="fas fa-users"></i>
        <span>Users</span>
      </a>
    </nav>

    <nav class="nav-section">
      <div class="nav-section-title">Management</div>
      <a href="#" class="nav-link">
        <i class="fas fa-bell"></i>
        <span>Notifications</span>
      </a>
      <a href="#" class="nav-link">
        <i class="fas fa-chart-bar"></i>
        <span>Analytics</span>
      </a>
      <a href="#" class="nav-link">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="admin-info">
        <div class="admin-avatar">A</div>
        <div class="admin-details">
          <h4>Admin User</h4>
          <p>Super Administrator</p>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1>
        <i class="fas fa-tachometer-alt"></i>
        Admin Dashboard
      </h1>
      <p>Welcome back! Here's an overview of your exam preparation platform's performance and key metrics.</p>
      <div class="welcome-message">
        <i class="fas fa-info-circle"></i>
        This dashboard provides real-time insights into your platform's performance, user engagement, and content management.
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card questions">
        <div class="stat-header">
          <div>
            <div class="stat-number" id="totalQuestions">—</div>
        <div class="stat-label">Total Questions</div>
            <div class="stat-change">+15% this month</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-question"></i>
          </div>
        </div>
      </div>

      <div class="stat-card mocks">
        <div class="stat-header">
          <div>
            <div class="stat-number" id="totalMocks">—</div>
            <div class="stat-label">Mock Tests</div>
            <div class="stat-change">+8% this month</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-list-ol"></i>
          </div>
        </div>
      </div>

      <div class="stat-card users">
        <div class="stat-header">
          <div>
            <div class="stat-number" id="totalUsers">—</div>
        <div class="stat-label">Total Users</div>
            <div class="stat-change">+12% this month</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
        </div>
      </div>

      <div class="stat-card active">
        <div class="stat-header">
          <div>
            <div class="stat-number" id="activeToday">—</div>
        <div class="stat-label">Active Today</div>
            <div class="stat-change">+5% vs yesterday</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-bolt"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <h3>
        <i class="fas fa-rocket"></i>
        Quick Actions
      </h3>
      <div class="actions-grid">
        <a href="admin-questions.html" class="action-card questions">
          <div class="action-icon">
            <i class="fas fa-plus"></i>
          </div>
          <div class="action-content">
            <h4>Add Questions</h4>
            <p>Create new questions for your exams</p>
          </div>
        </a>

        <a href="mock.html" class="action-card mocks">
          <div class="action-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div class="action-content">
            <h4>Manage Mocks</h4>
            <p>Create and organize mock tests</p>
          </div>
        </a>

        <a href="user.html" class="action-card users">
          <div class="action-icon">
            <i class="fas fa-user-cog"></i>
          </div>
          <div class="action-content">
            <h4>User Management</h4>
            <p>Manage user accounts and permissions</p>
          </div>
        </a>

        <a href="#" class="action-card">
          <div class="action-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="action-content">
            <h4>View Analytics</h4>
            <p>Detailed performance insights</p>
          </div>
        </a>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
      <h3>
        <i class="fas fa-clock"></i>
        Recent Activity
      </h3>
      <div id="activityLoading" class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        <div>Loading recent activity...</div>
      </div>
      <ul id="activityList" class="activity-list" style="display: none;">
        <!-- Activity items will be populated dynamically -->
      </ul>
      <div id="noActivity" class="empty-state" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <h3>No Recent Activity</h3>
        <p>Activity will appear here as users interact with the platform.</p>
      </div>
      <div id="activityError" class="empty-state" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Activity Service Unavailable</h3>
        <p>Unable to load recent activity. The service may be temporarily unavailable.</p>
        <small style="color: #9ca3af; margin-top: 0.5rem; display: block;">Check browser console for details</small>
      </div>
    </div>
  </main>

  <script>
    // Configuration
    const API_BASE = 'https://examprep-backend.onrender.com/api/admin';

    // Token management
    function isTokenExpired(token) {
      if (!token) return true;
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (!payload.exp) return false;
        const now = Math.floor(Date.now() / 1000);
        return payload.exp < now;
      } catch (e) {
        return true;
      }
    }

    function getAdminToken() {
      let token = localStorage.getItem('adminToken') || '';
      if (!token || isTokenExpired(token)) {
        token = prompt('Enter your admin JWT token:');
        if (token) {
          localStorage.setItem('adminToken', token);
        } else {
          throw new Error('No token provided');
        }
      }
      
      // Debug: Log token info
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        console.log('Token payload:', payload);
        console.log('Token expires:', new Date(payload.exp * 1000));
      } catch (e) {
        console.error('Invalid token format:', e);
      }
      
      return token;
    }

    // Validate token by trying to fetch stats (which requires admin auth)
    async function validateToken() {
      const token = getAdminToken();
      try {
        const response = await fetch(`${API_BASE}/stats`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Invalid or expired token');
          }
          throw new Error(`Server error: ${response.status}`);
        }
        
        // If we can fetch stats, the token is valid
        console.log('Token validation successful');
        return { name: 'Admin User' }; // Default admin name
      } catch (error) {
        console.error('Token validation failed:', error);
        if (error.message.includes('Invalid or expired token')) {
          localStorage.removeItem('adminToken');
          alert('Invalid or expired token. Please log in again.');
        }
        return null;
      }
    }

         // Fetch dashboard stats
     async function fetchStats() {
       const token = getAdminToken();
       try {
         const response = await fetch(`${API_BASE}/stats`, {
           headers: {
             'Authorization': `Bearer ${token}`
           }
         });

         if (!response.ok) {
           const errorData = await response.json().catch(() => ({}));
           console.error('Stats API Error:', errorData);
           
           if (response.status === 401) {
             // Token expired or invalid
             localStorage.removeItem('adminToken');
             alert('Authentication failed. Please log in again.');
             return;
           } else if (response.status === 404) {
             console.error('Stats endpoint not found - backend may not be deployed or endpoint missing');
             return;
           }
           
           throw new Error(`HTTP error! status: ${response.status} - ${errorData.message || 'Unknown error'}`);
         }

         const stats = await response.json();
         
         // Update stats with proper formatting
         document.getElementById('totalQuestions').textContent = (stats.totalQuestions || 0).toLocaleString();
         document.getElementById('totalMocks').textContent = (stats.totalMocks || 0).toLocaleString();
         document.getElementById('totalUsers').textContent = (stats.totalUsers || 0).toLocaleString();
         document.getElementById('activeToday').textContent = (stats.activeToday || 0).toLocaleString();

       } catch (error) {
         console.error('Error fetching stats:', error);
         // Show fallback values
         document.getElementById('totalQuestions').textContent = '0';
         document.getElementById('totalMocks').textContent = '0';
         document.getElementById('totalUsers').textContent = '0';
         document.getElementById('activeToday').textContent = '0';
       }
     }

     // Fetch recent activity
     async function fetchRecentActivity() {
       const token = getAdminToken();
       try {
         const response = await fetch(`${API_BASE}/activity`, {
           headers: {
             'Authorization': `Bearer ${token}`
           }
         });

         if (!response.ok) {
           const errorData = await response.json().catch(() => ({}));
           console.error('Activity API Error:', errorData);
           
           if (response.status === 401) {
             // Token expired or invalid
             localStorage.removeItem('adminToken');
             alert('Authentication failed. Please log in again.');
             return;
           } else if (response.status === 404) {
             console.error('Activity endpoint not found - backend may not be deployed or endpoint missing');
             showNoActivity();
             return;
           } else if (response.status === 500) {
             console.error('Activity endpoint server error:', errorData);
             console.log('This usually means:');
             console.log('1. Activity model/collection not created in database');
             console.log('2. Database connection issues');
             console.log('3. Missing middleware or dependencies');
             console.log('4. Error in activity route logic');
             showActivityError();
             return;
           }
           
           throw new Error(`HTTP error! status: ${response.status} - ${errorData.message || 'Unknown error'}`);
         }

         const activities = await response.json();
         renderActivity(activities);

       } catch (error) {
         console.error('Error fetching activity:', error);
         // Show fallback activity or empty state
         showNoActivity();
       }
     }

     // Render activity list
     function renderActivity(activities) {
       const activityList = document.getElementById('activityList');
       const activityLoading = document.getElementById('activityLoading');
       const noActivity = document.getElementById('noActivity');

       // Hide loading
       activityLoading.style.display = 'none';

       if (!activities || activities.length === 0) {
         showNoActivity();
         return;
       }

       // Show activity list
       activityList.style.display = 'block';
       noActivity.style.display = 'none';

       activityList.innerHTML = activities.map(activity => {
         const icon = getActivityIcon(activity.type);
         const timeAgo = getTimeAgo(activity.timestamp);
         
         return `
           <li class="activity-item">
             <div class="activity-icon">
               <i class="${icon}"></i>
             </div>
             <div class="activity-content">
               <h4>${activity.title}</h4>
               <p>${activity.description}</p>
               <small style="color: #9ca3af; font-size: 0.8rem;">by ${activity.adminName}</small>
             </div>
             <div class="activity-time">${timeAgo}</div>
           </li>
         `;
       }).join('');
     }

     // Show no activity state
     function showNoActivity() {
       document.getElementById('activityLoading').style.display = 'none';
       document.getElementById('activityList').style.display = 'none';
       document.getElementById('noActivity').style.display = 'block';
       document.getElementById('activityError').style.display = 'none';
     }

     // Show activity error state
     function showActivityError() {
       document.getElementById('activityLoading').style.display = 'none';
       document.getElementById('activityList').style.display = 'none';
       document.getElementById('noActivity').style.display = 'none';
       document.getElementById('activityError').style.display = 'block';
     }

     // Get activity icon based on type
     function getActivityIcon(type) {
       const icons = {
         'question_created': 'fas fa-question',
         'question_updated': 'fas fa-edit',
         'question_deleted': 'fas fa-trash',
         'mock_created': 'fas fa-list-ol',
         'mock_updated': 'fas fa-edit',
         'mock_deleted': 'fas fa-trash',
         'user_updated': 'fas fa-user-edit',
         'user_deleted': 'fas fa-user-times',
         'csv_uploaded': 'fas fa-file-csv',
         'settings_changed': 'fas fa-cog',
         'default': 'fas fa-info-circle'
       };
       return icons[type] || icons.default;
     }

     // Get time ago string
     function getTimeAgo(timestamp) {
       const now = new Date();
       const activityTime = new Date(timestamp);
       const diffInSeconds = Math.floor((now - activityTime) / 1000);

       if (diffInSeconds < 60) {
         return 'Just now';
       } else if (diffInSeconds < 3600) {
         const minutes = Math.floor(diffInSeconds / 60);
         return `${minutes} min ago`;
       } else if (diffInSeconds < 86400) {
         const hours = Math.floor(diffInSeconds / 3600);
         return `${hours} hour${hours > 1 ? 's' : ''} ago`;
       } else {
         const days = Math.floor(diffInSeconds / 86400);
         return `${days} day${days > 1 ? 's' : ''} ago`;
       }
     }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('adminToken');
        window.location.href = '../login.html';
      }
    }

         // Initialize dashboard
     document.addEventListener('DOMContentLoaded', function() {
       // Try to fetch data directly - if token is invalid, the functions will handle it
    fetchStats();
       fetchRecentActivity();
       
       // Refresh stats every 5 minutes
       setInterval(fetchStats, 5 * 60 * 1000);
       
       // Refresh activity every 2 minutes
       setInterval(fetchRecentActivity, 2 * 60 * 1000);
     });

    // Add smooth scrolling for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  </script>
</body>
</html> 
</html> 