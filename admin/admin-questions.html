<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Manage Questions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      background: #f6f8fa;
      color: #222;
    }
    .container {
      max-width: 1100px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px 0 rgba(80, 40, 120, 0.08);
      padding: 2.5rem 2rem 2rem 2rem;
    }
    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #4f46e5;
      letter-spacing: -1px;
    }
    .filters {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .filters label {
      font-weight: 500;
      color: #555;
    }
    .filters input, .filters select {
      padding: 0.4rem 0.7rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      background: #f9fafb;
      margin-left: 0.4rem;
    }
    .filters button {
      background: linear-gradient(100deg, #7c3aed 0%, #6366f1 100%);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 rgba(99,102,241,0.10);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .filters button:hover {
      background: linear-gradient(100deg, #6d28d9 0%, #4f46e5 100%);
      box-shadow: 0 4px 16px 0 rgba(99,102,241,0.13);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 12px 0 rgba(80, 40, 120, 0.06);
    }
    th, td {
      border-bottom: 1px solid #f1f1f1;
      padding: 0.85rem 0.7rem;
      text-align: left;
      font-size: 1rem;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
      color: #4f46e5;
      letter-spacing: 0.5px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    td.actions {
      min-width: 120px;
    }
    .action-btn {
      background: none;
      border: none;
      color: #6366f1;
      font-size: 1.1rem;
      margin: 0 0.3rem;
      cursor: pointer;
      transition: color 0.18s;
      border-radius: 0.4rem;
      padding: 0.3rem 0.5rem;
    }
    .action-btn:hover {
      background: #f3f4f6;
      color: #4f46e5;
    }
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.18);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 8px 32px 0 rgba(80, 40, 120, 0.13);
      padding: 2rem 2.5rem 1.5rem 2.5rem;
      min-width: 320px;
      max-width: 95vw;
      position: relative;
      animation: popIn 0.18s;
      max-height: 90vh;
      overflow-y: auto;
    }
    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal h3 {
      font-size: 1.3rem;
      font-weight: 700;
      color: #4f46e5;
      margin-bottom: 1.2rem;
    }
    .modal label {
      display: block;
      margin-bottom: 0.7rem;
      color: #444;
      font-weight: 500;
      position: relative;
    }
    .required-star {
      color: #e11d48;
      margin-left: 2px;
      font-size: 1.1em;
      font-weight: bold;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 0.5rem 0.7rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      background: #f9fafb;
      margin-bottom: 1.1rem;
    }
    .modal .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 0.5rem;
    }
    .modal .modal-actions button {
      padding: 0.5rem 1.2rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.18s;
    }
    .modal .modal-actions .save {
      background: linear-gradient(100deg, #7c3aed 0%, #6366f1 100%);
      color: #fff;
    }
    .modal .modal-actions .save:hover {
      background: linear-gradient(100deg, #6d28d9 0%, #4f46e5 100%);
    }
    .modal .modal-actions .cancel {
      background: #f3f4f6;
      color: #4f46e5;
    }
    .modal .modal-actions .cancel:hover {
      background: #e0e7ef;
    }
    @media (max-width: 600px) {
      .container { padding: 1rem 0.3rem; }
      .modal { padding: 1.2rem 0.7rem; }
      th, td { font-size: 0.95rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-cogs"></i> Admin: Manage Questions</h1>
    <div id="adminMsg" style="margin-bottom:1rem;min-height:28px;font-weight:600;"></div>
    <div class="filters">
      <label>Exam: <input id="exam" value="CAT"></label>
      <label>Day: <input id="day" type="number" value="1"></label>
      <label>Type: 
        <select id="type">
          <option value="">All</option>
          <option value="mock">Mock</option>
          <option value="practice">Practice</option>
        </select>
      </label>
      <button onclick="fetchQuestions()"><i class="fas fa-search"></i> Fetch Questions</button>
      <button onclick="showCreateModal()" style="margin-left:1rem;background:linear-gradient(100deg,#10b981 0%,#6366f1 100%);color:#fff;"><i class="fas fa-plus"></i> Create New Question</button>
      <label style="margin-left:1rem;display:flex;align-items:center;gap:0.5rem;">
        <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="handleCSVSelected(event)">
        <button type="button" onclick="document.getElementById('csvFileInput').click()" style="background:linear-gradient(100deg,#6366f1 0%,#10b981 100%);color:#fff;"><i class="fas fa-upload"></i> Bulk Upload (CSV)</button>
      </label>
      <span style="font-size:0.98em;color:#6b7280;margin-left:0.5rem;">CSV columns: <b>id,question,option1,option2,option3,option4,answerIndex,explanation,chapter,exam,day,section,type</b> (for <b>practice</b> questions, day and section can be left blank)</span>
      <button type="button" onclick="downloadQuestionsCSV()" style="margin-left:1rem;background:linear-gradient(100deg,#6366f1 0%,#10b981 100%);color:#fff;"><i class="fas fa-download"></i> Download All as CSV</button>
      <button type="button" onclick="downloadTemplateCSV()" style="margin-left:1rem;background:linear-gradient(100deg,#10b981 0%,#6366f1 100%);color:#fff;"><i class="fas fa-file-csv"></i> Download Template CSV</button>
    </div>
    <table id="questionsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Question</th>
          <th>Section</th>
          <th>Type</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Edit Modal -->
  <div id="editModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
      <h3><i class="fas fa-edit"></i> Edit Question</h3>
      <form id="editForm">
        <label>Exam<span class="required-star">*</span>: <input id="editExam" required style="width: 160px;"></label>
        <label id="labelEditDay">Day<span class="required-star" id="starEditDay">*</span>: <input id="editDay" type="number" style="width: 100px;"></label>
        <label id="labelEditSection">Section<span class="required-star" id="starEditSection">*</span>: <input id="editSection" style="width: 160px;"></label>
        <label>ID<span class="required-star">*</span>: <input id="editId" required style="width: 160px;" readonly></label>
        <label>Image URL: <input id="editImg" style="width: 220px;"></label>
        <label>Passage: <textarea id="editPassage" rows="4" style="width: 98%; min-width: 350px; min-height: 60px;"></textarea></label>
        <label>Question<span class="required-star">*</span>: <textarea id="editQuestion" required rows="4" style="width: 98%; min-width: 350px; min-height: 60px;"></textarea></label>
        <label>Options<span class="required-star">*</span>:</label>
        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
          <input id="editOption0" required placeholder="Option 1" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
          <input id="editOption1" required placeholder="Option 2" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
          <input id="editOption2" required placeholder="Option 3" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
          <input id="editOption3" required placeholder="Option 4" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
        </div>
        <label>Answer Index<span class="required-star">*</span> (0-3): <input id="editAnswerIndex" type="number" min="0" max="3" required style="width: 100px;"></label>
        <label>Explanation: <textarea id="editExplanation" rows="3" style="width: 98%; min-width: 350px; min-height: 50px;"></textarea></label>
        <label>Video: <input id="editVideo" style="width: 220px;"></label>
        <label>Video URL: <input id="editVideoUrl" style="width: 220px;"></label>
        <label>Video Start (seconds): <input id="editVideoStart" type="number" min="0" style="width: 120px;"></label>
        <label>Type<span class="required-star">*</span>: 
          <select id="editType" required style="width: 120px;" onchange="updateEditMockFieldsRequired()">
            <option value="mock">Mock</option>
            <option value="practice">Practice</option>
          </select>
        </label>
        <div class="modal-actions">
          <button type="submit" class="save" id="editSubmitBtn"><span id="editSpinner" style="display:none;"><i class='fas fa-spinner fa-spin'></i></span> <i class="fas fa-save"></i> Save</button>
          <button type="button" class="cancel" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Modal -->
  <div id="createModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
      <h3><i class="fas fa-plus"></i> Create New Question</h3>
      <form id="createForm">
        <label>Exam<span class="required-star">*</span>: <input id="createExam" required style="width: 160px;"></label>
        <label id="labelCreateDay">Day<span class="required-star" id="starCreateDay">*</span>: <input id="createDay" type="number" style="width: 100px;"></label>
        <label id="labelCreateSection">Section<span class="required-star" id="starCreateSection">*</span>: <input id="createSection" style="width: 160px;"></label>
        <label>ID<span class="required-star">*</span>: <input id="createId" required style="width: 160px;"></label>
        <label>Image URL: <input id="createImg" style="width: 220px;"></label>
        <label>Passage: <textarea id="createPassage" rows="4" style="width: 98%; min-width: 350px; min-height: 60px;"></textarea></label>
        <label>Question<span class="required-star">*</span>: <textarea id="createQuestion" required rows="4" style="width: 98%; min-width: 350px; min-height: 60px;"></textarea></label>
        <label>Options<span class="required-star">*</span>:</label>
        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
          <input id="createOption0" required placeholder="Option 1" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
          <input id="createOption1" required placeholder="Option 2" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
          <input id="createOption2" required placeholder="Option 3" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
          <input id="createOption3" required placeholder="Option 4" style="flex:1 1 220px; min-width:180px; padding:0.7rem; font-size:1.1em;">
        </div>
        <label>Answer Index<span class="required-star">*</span> (0-3): <input id="createAnswerIndex" type="number" min="0" max="3" required style="width: 100px;"></label>
        <label>Explanation: <textarea id="createExplanation" rows="3" style="width: 98%; min-width: 350px; min-height: 50px;"></textarea></label>
        <label>Video: <input id="createVideo" style="width: 220px;"></label>
        <label>Video URL: <input id="createVideoUrl" style="width: 220px;"></label>
        <label>Video Start (seconds): <input id="createVideoStart" type="number" min="0" style="width: 120px;"></label>
        <label>Type<span class="required-star">*</span>: 
          <select id="createType" required style="width: 120px;" onchange="updateMockFieldsRequired()">
            <option value="mock">Mock</option>
            <option value="practice">Practice</option>
          </select>
        </label>
        <div class="modal-actions">
          <button type="submit" class="save" id="createSubmitBtn"><span id="createSpinner" style="display:none;"><i class='fas fa-spinner fa-spin'></i></span> <i class="fas fa-plus"></i> Create</button>
          <button type="button" class="cancel" onclick="closeCreateModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Set your backend API base URL here
    // const API_BASE = 'http://localhost:5050/api/admin'; // For local testing
    const API_BASE = 'https://examprep-backend.onrender.com/api/admin'; // For production

    function isTokenExpired(token) {
      if (!token) return true;
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (!payload.exp) return false; // No exp field, assume not expired
        const now = Math.floor(Date.now() / 1000);
        return payload.exp < now;
      } catch (e) {
        return true; // Invalid token format
      }
    }
    async function fetchQuestions() {
      let ADMIN_TOKEN = localStorage.getItem('adminToken') || '';
      if (!ADMIN_TOKEN || isTokenExpired(ADMIN_TOKEN)) {
        ADMIN_TOKEN = prompt('Enter your admin JWT token:');
        localStorage.setItem('adminToken', ADMIN_TOKEN);
      }
      const exam = document.getElementById('exam').value;
      const day = document.getElementById('day').value;
      const type = document.getElementById('type').value;
      let url = `${API_BASE}/questions?exam=${encodeURIComponent(exam)}&day=${encodeURIComponent(day)}`;
      if (type) url += `&type=${encodeURIComponent(type)}`;
      try {
        const res = await fetch(url, {
          headers: { Authorization: 'Bearer ' + ADMIN_TOKEN }
        });
        if (res.status === 401) {
          alert('Session expired or unauthorized. Please log in again.');
          localStorage.removeItem('adminToken');
          window.location.reload();
          return;
        }
        const questions = await res.json();
        renderQuestions(questions);
      } catch (e) {
        alert('Failed to fetch questions. Please check your connection.');
      }
    }

    function renderQuestions(questions) {
      const tbody = document.querySelector('#questionsTable tbody');
      tbody.innerHTML = '';
      questions.forEach(q => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${q.id || q._id}</td>
          <td>${q.question}</td>
          <td>${q.section || ''}</td>
          <td>${q.type || ''}</td>
          <td class="actions">
            <button class="action-btn" title="Edit" onclick="window._editQuestionObj = ${JSON.stringify(q).replace(/"/g, '&quot;')}; showEditModal()"><i class="fas fa-edit"></i></button>
            <button class="action-btn" title="Delete" onclick="deleteQuestion('${q._id}')"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.showEditModal = function(id, question, section, type) {
      // Fetch the full question object from the table row or API if needed
      const q = window._editQuestionObj || {};
      document.getElementById('editId').value = q.id || '';
      document.getElementById('editExam').value = q.exam || '';
      document.getElementById('editDay').value = q.day || '';
      document.getElementById('editSection').value = q.section || '';
      document.getElementById('editImg').value = q.img || '';
      document.getElementById('editPassage').value = q.passage || '';
      document.getElementById('editQuestion').value = q.question || '';
      (q.options || []).forEach((opt, i) => {
        if (i < 4) document.getElementById('editOption'+i).value = opt;
      });
      for (let i = (q.options||[]).length; i < 4; i++) document.getElementById('editOption'+i).value = '';
      document.getElementById('editAnswerIndex').value = q.answerIndex ?? '';
      document.getElementById('editExplanation').value = q.explanation || '';
      document.getElementById('editVideo').value = q.video || '';
      document.getElementById('editVideoUrl').value = q.videoUrl || '';
      document.getElementById('editVideoStart').value = q.videoStart ?? '';
      document.getElementById('editType').value = q.type || 'mock';
      updateEditMockFieldsRequired();
      document.getElementById('editModalBg').style.display = 'flex';
    }

    window.closeEditModal = function() {
      document.getElementById('editModalBg').style.display = 'none';
    }

    document.getElementById('editForm').onsubmit = async function(e) {
      e.preventDefault();
      let ADMIN_TOKEN = localStorage.getItem('adminToken') || '';
      if (!ADMIN_TOKEN || isTokenExpired(ADMIN_TOKEN)) {
        ADMIN_TOKEN = prompt('Enter your admin JWT token:');
        localStorage.setItem('adminToken', ADMIN_TOKEN);
      }
      const btn = document.getElementById('editSubmitBtn');
      const spinner = document.getElementById('editSpinner');
      btn.disabled = true; spinner.style.display = '';
      const exam = document.getElementById('editExam').value.trim();
      const day = document.getElementById('editDay').value;
      const section = document.getElementById('editSection').value.trim();
      const id = document.getElementById('editId').value.trim();
      const img = document.getElementById('editImg').value.trim() || null;
      const passage = document.getElementById('editPassage').value.trim() || null;
      const question = document.getElementById('editQuestion').value.trim();
      const options = [
        document.getElementById('editOption0').value.trim(),
        document.getElementById('editOption1').value.trim(),
        document.getElementById('editOption2').value.trim(),
        document.getElementById('editOption3').value.trim()
      ];
      const answerIndex = Number(document.getElementById('editAnswerIndex').value);
      const explanation = document.getElementById('editExplanation').value.trim();
      const video = document.getElementById('editVideo').value.trim();
      const videoUrl = document.getElementById('editVideoUrl').value.trim();
      const videoStart = document.getElementById('editVideoStart').value ? Number(document.getElementById('editVideoStart').value) : undefined;
      const type = document.getElementById('editType').value;
      // Validation
      if (!exam || !id || !question || !type) {
        showAdminMsg('Please fill all required fields.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      if (type === 'mock' && (day === '' || section === '')) {
        showAdminMsg('Day and Section are required for mock questions.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      if (options.some(opt => !opt)) {
        showAdminMsg('All options must be filled.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      if (answerIndex < 0 || answerIndex >= options.length || isNaN(answerIndex)) {
        showAdminMsg('Answer Index must be between 0 and 3.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      try {
        const res = await fetch(`${API_BASE}/questions/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + ADMIN_TOKEN
          },
          body: JSON.stringify({ exam, day, section, id, img, passage, question, options, answerIndex, explanation, video, videoUrl, videoStart, type })
        });
        if (!res.ok) {
          let msg = 'Failed to update question.';
          try {
            const err = await res.json();
            msg += ' ' + (err.message || JSON.stringify(err));
          } catch {}
          showAdminMsg(msg, true);
          btn.disabled = false; spinner.style.display = 'none';
          return;
        }
        closeEditModal();
        fetchQuestions();
        showAdminMsg('Question updated successfully!');
      } catch (e) {
        showAdminMsg('Failed to update question. ' + e.message, true);
      }
      btn.disabled = false; spinner.style.display = 'none';
    };

    window.deleteQuestion = async function(id) {
      let ADMIN_TOKEN = localStorage.getItem('adminToken') || '';
      if (!ADMIN_TOKEN || isTokenExpired(ADMIN_TOKEN)) {
        ADMIN_TOKEN = prompt('Enter your admin JWT token:');
        localStorage.setItem('adminToken', ADMIN_TOKEN);
      }
      if (!confirm('Are you sure you want to delete this question?')) return;
      try {
        await fetch(`${API_BASE}/questions/${id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + ADMIN_TOKEN }
        });
        fetchQuestions();
      } catch (e) {
        showAdminMsg('Failed to delete question.', true);
      }
    }

    window.showCreateModal = function() {
      document.getElementById('createExam').value = '';
      document.getElementById('createDay').value = '';
      document.getElementById('createSection').value = '';
      document.getElementById('createId').value = '';
      document.getElementById('createImg').value = '';
      document.getElementById('createPassage').value = '';
      document.getElementById('createQuestion').value = '';
      document.getElementById('createOption0').value = '';
      document.getElementById('createOption1').value = '';
      document.getElementById('createOption2').value = '';
      document.getElementById('createOption3').value = '';
      document.getElementById('createAnswerIndex').value = '';
      document.getElementById('createExplanation').value = '';
      document.getElementById('createVideo').value = '';
      document.getElementById('createVideoUrl').value = '';
      document.getElementById('createVideoStart').value = '';
      document.getElementById('createType').value = 'mock';
      document.getElementById('createModalBg').style.display = 'flex';
    }
    window.closeCreateModal = function() {
      document.getElementById('createModalBg').style.display = 'none';
    }
    function showAdminMsg(msg, isError = false) {
      const el = document.getElementById('adminMsg');
      el.textContent = msg;
      el.style.color = isError ? '#e11d48' : '#059669';
      el.style.background = isError ? '#fef2f2' : '#f0fdf4';
      el.style.borderRadius = '6px';
      el.style.padding = '0.4em 1em';
      el.style.transition = 'all 0.2s';
      if (msg) setTimeout(() => { el.textContent = ''; el.style.background = 'none'; }, 4000);
    }
    document.getElementById('createForm').onsubmit = async function(e) {
      e.preventDefault();
      const btn = document.getElementById('createSubmitBtn');
      const spinner = document.getElementById('createSpinner');
      btn.disabled = true; spinner.style.display = '';
      let ADMIN_TOKEN = localStorage.getItem('adminToken') || '';
      if (!ADMIN_TOKEN || isTokenExpired(ADMIN_TOKEN)) {
        ADMIN_TOKEN = prompt('Enter your admin JWT token:');
        localStorage.setItem('adminToken', ADMIN_TOKEN);
      }
      // Validation
      const exam = document.getElementById('createExam').value.trim();
      const id = document.getElementById('createId').value.trim();
      const question = document.getElementById('createQuestion').value.trim();
      const type = document.getElementById('createType').value;
      // Client-side validation
      if (!exam || !id || !question || !type) {
        showAdminMsg('Please fill all required fields.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      if (type === 'mock' && (document.getElementById('createDay').value === '' || document.getElementById('createSection').value.trim() === '')) {
        showAdminMsg('Day and Section are required for mock questions.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      if (options.some(opt => !opt)) {
        showAdminMsg('All options must be filled.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      if (answerIndex < 0 || answerIndex >= options.length || isNaN(answerIndex)) {
        showAdminMsg('Answer Index must be between 0 and 3.', true); btn.disabled = false; spinner.style.display = 'none'; return;
      }
      try {
        const res = await fetch(`${API_BASE}/questions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + ADMIN_TOKEN
          },
          body: JSON.stringify({ exam, day, section, id, img, passage, question, options, answerIndex, explanation, video, videoUrl, videoStart, type })
        });
        if (!res.ok) {
          const err = await res.json();
          showAdminMsg('Error: ' + (err.message || 'Submission failed.'), true);
        } else {
          showAdminMsg('Question created successfully!');
          closeCreateModal();
          fetchQuestions();
        }
      } catch (e) {
        showAdminMsg('Network or server error.', true);
      }
      btn.disabled = false; spinner.style.display = 'none';
    };
    window.handleCSVSelected = async function(event) {
      let ADMIN_TOKEN = localStorage.getItem('adminToken') || '';
      if (!ADMIN_TOKEN || isTokenExpired(ADMIN_TOKEN)) {
        ADMIN_TOKEN = prompt('Enter your admin JWT token:');
        localStorage.setItem('adminToken', ADMIN_TOKEN);
      }
      const file = event.target.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      const res = await fetch(`${API_BASE}/questions/upload-csv`, {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + ADMIN_TOKEN },
        body: formData
      });
      if (res.ok) {
        showAdminMsg('CSV uploaded successfully!');
        fetchQuestions();
      } else {
        const err = await res.json().catch(() => ({}));
        showAdminMsg('CSV upload failed: ' + (err.message || 'Invalid file or schema.'), true);
      }
      document.getElementById('csvFileInput').value = '';
    }

    window.downloadQuestionsCSV = async function() {
      let ADMIN_TOKEN = localStorage.getItem('adminToken') || '';
      if (!ADMIN_TOKEN || isTokenExpired(ADMIN_TOKEN)) {
        ADMIN_TOKEN = prompt('Enter your admin JWT token:');
        localStorage.setItem('adminToken', ADMIN_TOKEN);
      }
      try {
        const exam = document.getElementById('exam').value;
        const day = document.getElementById('day').value;
        let url = `${API_BASE}/questions?exam=${encodeURIComponent(exam)}&day=${encodeURIComponent(day)}`;
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + ADMIN_TOKEN } });
        const questions = await res.json();
        if (!Array.isArray(questions) || !questions.length) {
          showAdminMsg('No questions to download.', true); return;
        }
        // CSV header
        const header = ['exam','day','section','id','img','passage','question','options','answerIndex','explanation','video','videoUrl','videoStart','type'];
        const csv = [header.join(',')].concat(
          questions.map(q => header.map(h => {
            let v = q[h];
            if (Array.isArray(v)) v = '"' + v.join('|') + '"';
            if (typeof v === 'string') v = '"' + v.replace(/"/g,'""') + '"';
            return v ?? '';
          }).join(','))
        ).join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'questions.csv';
        a.click();
      } catch (e) {
        showAdminMsg('Failed to download CSV.', true);
      }
    }
    function updateMockFieldsRequired() {
      const type = document.getElementById('createType').value;
      const dayInput = document.getElementById('createDay');
      const sectionInput = document.getElementById('createSection');
      const dayLabel = document.getElementById('labelCreateDay');
      const sectionLabel = document.getElementById('labelCreateSection');
      const starDay = document.getElementById('starCreateDay');
      const starSection = document.getElementById('starCreateSection');
      if (type === 'mock') {
        dayInput.required = true;
        sectionInput.required = true;
        starDay.style.display = '';
        starSection.style.display = '';
        dayLabel.style.opacity = 1;
        sectionLabel.style.opacity = 1;
      } else {
        dayInput.required = false;
        sectionInput.required = false;
        starDay.style.display = 'none';
        starSection.style.display = 'none';
        dayLabel.style.opacity = 0.7;
        sectionLabel.style.opacity = 0.7;
      }
    }
    document.getElementById('createType').addEventListener('change', updateMockFieldsRequired);
    updateMockFieldsRequired();
    function updateEditMockFieldsRequired() {
      const type = document.getElementById('editType').value;
      const dayInput = document.getElementById('editDay');
      const sectionInput = document.getElementById('editSection');
      const dayLabel = document.getElementById('labelEditDay');
      const sectionLabel = document.getElementById('labelEditSection');
      const starDay = document.getElementById('starEditDay');
      const starSection = document.getElementById('starEditSection');
      if (type === 'mock') {
        dayInput.required = true;
        sectionInput.required = true;
        starDay.style.display = '';
        starSection.style.display = '';
        dayLabel.style.opacity = 1;
        sectionLabel.style.opacity = 1;
      } else {
        dayInput.required = false;
        sectionInput.required = false;
        starDay.style.display = 'none';
        starSection.style.display = 'none';
        dayLabel.style.opacity = 0.7;
        sectionLabel.style.opacity = 0.7;
      }
    }
    document.getElementById('editType').addEventListener('change', updateEditMockFieldsRequired);
    updateEditMockFieldsRequired();
    window.downloadTemplateCSV = function() {
      const header = ['id','question','option1','option2','option3','option4','answerIndex','explanation','chapter','exam','day','section','type'];
      const exampleMock = ['32','What is the capital of France?','Berlin','Madrid','Paris','Rome','3','Paris is the capital of France.','Geography','Midterm','1','A','mock'];
      const examplePractice = ['f','What is H2O commonly known as?','Oxygen','Hydrogen','Water','Carbon Dioxide','3','H2O is the chemical formula for water.','Science','Midterm','','','practice'];
      const csv = [header.join(','), exampleMock.join(','), examplePractice.join(',')].join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'questions_template.csv';
      a.click();
    }

    // Initial fetch
    fetchQuestions();
  </script>
</body>
</html> 