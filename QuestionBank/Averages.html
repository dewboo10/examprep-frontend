<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Averages Question Bank</title>
  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-3xl mx-auto py-8 px-4">
    <h1 class="text-3xl font-bold text-indigo-700 mb-6 text-center">Averages - Practice Questions</h1>
    <div id="questions-list" class="space-y-10"></div>
  </div>

  <script>
const topic = "Average";
const level = "easy";
const questionsList = document.getElementById('questions-list');
const API_BASE = "https://examprep-backend.onrender.com";

// Fetch and render questions
fetch(`${API_BASE}/api/questions/topic/${topic}?level=${level}`)
  .then(res => res.json())
  .then(questions => {
    questions.forEach(q => renderQuestion(q));
  });

function renderQuestion(question) {
  const qDiv = document.createElement('div');
  qDiv.className = 'question-block bg-white rounded-xl shadow p-6';

  // Question text
  qDiv.innerHTML = `<h3 class="font-bold text-lg mb-2">${question.question}</h3>`;

  // Options
  const optionsDiv = document.createElement('div');
  optionsDiv.className = 'options-list space-y-2 mb-2';
  question.options.forEach((opt, idx) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn w-full text-left px-4 py-2 rounded border border-gray-200 bg-gray-50 hover:bg-indigo-50 transition';
    btn.textContent = opt;
    btn.onclick = () => handleAnswer(idx, btn, question, qDiv, optionsDiv);
    optionsDiv.appendChild(btn);
  });
  qDiv.appendChild(optionsDiv);

  // Placeholder for analytics, answer, comments (hidden initially)
  const revealDiv = document.createElement('div');
  revealDiv.style.display = 'none';
  qDiv.appendChild(revealDiv);

  questionsList.appendChild(qDiv);
}

async function handleAnswer(selectedIdx, btn, question, qDiv, optionsDiv) {
  // Disable all options
  Array.from(optionsDiv.children).forEach(b => b.disabled = true);

  // Mark selected
  btn.classList.add('bg-indigo-100', 'border-indigo-400');
  const isCorrect = selectedIdx === question.correctOption;
  btn.classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100');

  // Optionally: POST answer for analytics (if you have such endpoint)
  // await fetch(`${API_BASE}/answers`, { ... })

  // Fetch analytics/meta
  const analyticsRes = await fetch(`${API_BASE}/api/questions/${question._id}/analytics`);
  const analytics = await analyticsRes.json();

  // Reveal answer, explanation, analytics, comments
  const revealDiv = qDiv.querySelector('div:last-child');
  revealDiv.style.display = '';
  revealDiv.innerHTML = `
    <div class="mt-4 p-4 rounded bg-gray-50 border">
      <div class="mb-2">
        <span class="font-semibold">Your answer:</span>
        <span class="${isCorrect ? 'text-green-600' : 'text-red-600'} font-bold">
          ${question.options[selectedIdx]}
        </span>
        <span class="ml-2">${isCorrect ? '✅ Correct!' : '❌ Incorrect'}</span>
      </div>
      <div class="mb-2">
        <span class="font-semibold">Correct answer:</span>
        <span class="text-indigo-700 font-bold">${question.options[question.correctOption]}</span>
      </div>
      <div class="mb-2">
        <span class="font-semibold">Explanation:</span>
        <span>${question.explanation || 'No explanation provided.'}</span>
      </div>
      <div class="mb-2">
        <span class="font-semibold">Analytics:</span>
        <ul class="ml-4 text-sm">
          <li>Answered Correctly: <b>${analytics.correctCount}</b> / ${analytics.totalAttempts} (${analytics.successRate || 0}%)</li>
          <li>Average Time Spent: <b>${analytics.averageTimeSpent || 0}</b> sec</li>
          <li>Difficulty: <b>${analytics.difficulty || 'N/A'}</b></li>
          <li>Option Breakdown:
            <ul>
              ${analytics.optionCounts.map((count, i) =>
                `<li>${question.options[i]}: <b>${count}</b></li>`
              ).join('')}
            </ul>
          </li>
        </ul>
      </div>
      <div class="comment-section mt-4">
        <h4 class="font-semibold mb-2">Comments & Doubts</h4>
        <div class="comments-list space-y-2 mb-2"></div>
        <textarea class="comment-input w-full border rounded p-2 mb-2" placeholder="Add a comment or doubt..."></textarea>
        <button class="post-comment-btn bg-indigo-600 text-white px-4 py-2 rounded">Post</button>
      </div>
    </div>
  `;

  // Load comments
  loadComments(question._id, revealDiv.querySelector('.comments-list'));

  // Post comment handler
  const postBtn = revealDiv.querySelector('.post-comment-btn');
  postBtn.onclick = async () => {
    const text = revealDiv.querySelector('.comment-input').value;
    if (!text) return;
    await fetch(`${API_BASE}/api/comments`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      },
      body: JSON.stringify({
        questionId: question._id,
        text,
        type: 'comment'
      })
    });
    revealDiv.querySelector('.comment-input').value = '';
    loadComments(question._id, revealDiv.querySelector('.comments-list'));
  };
}

// Read user info from localStorage
const user = JSON.parse(localStorage.getItem('user') || '{}');
const currentUserId = user.id;
const userRole = user.role;

async function loadComments(questionId, commentsDiv) {
  const res = await fetch(`${API_BASE}/api/comments?questionId=${questionId}`);
  const comments = await res.json();
  commentsDiv.innerHTML = comments.length
    ? comments.map(
        c => `<div class="comment p-2 bg-gray-100 rounded flex justify-between items-center">
                <span>
                  <b>${c.userId?.name || 'User'}:</b> ${c.text} <i class="text-xs text-gray-500">(${c.type})</i>
                </span>
                ${
                  (c.userId?._id === currentUserId || userRole === 'admin')
                  ? `<button class="delete-comment-btn text-red-500 ml-2" data-id="${c._id}">Delete</button>`
                  : ''
                }
              </div>`
      ).join('')
    : '<div class="text-gray-400 text-sm">No comments yet.</div>';

  // Add delete button handlers
  commentsDiv.querySelectorAll('.delete-comment-btn').forEach(btn => {
    btn.onclick = async () => {
      if (!confirm('Delete this comment?')) return;
      await fetch(`${API_BASE}/api/comments/${btn.dataset.id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      loadComments(questionId, commentsDiv);
    };
  });
}
  </script>
</body>
</html>
